# ClStock システムアーキテクチャ

## 概要

ClStockは、株価予測と投資判断支援を行うAIシステムです。84.6%（一部条件下で87.5%）の高精度予測を実現し、リアルタイムな投資判断を提供します。

## アーキテクチャ概要図

```
[ユーザー/クライアント] 
       |
       v
[APIサーバー (FastAPI)]
       |
       v
[CLIインターフェース (clstock_cli.py)]
       |
       v
[コアロジック (models/)]
       |
       v
[データ層 (data/)]
       |
       v
[外部API/データソース]
```

## レイヤー別詳細

### 1. API レイヤー

#### ファイル構成
- `app/main.py`: FastAPIアプリケーションのエントリーポイント
- `api/endpoints.py`: 公開APIエンドポイント
- `api/secure_endpoints.py`: 認証が必要なセキュアなAPIエンドポイント
- `api/security.py`: 認証・認可ロジック

#### 機能
- **RESTful API**: 株価データや推奨銘柄の取得を行うREST APIを提供
- **認証・認可**: トークンによるAPIアクセス制御
- **入力検証**: クライアントからの入力検証
- **エラーハンドリング**: API呼び出し時のエラー処理

#### 主要エンドポイント
- `GET /api/v1/recommendations`: 上位N件の推奨銘柄取得
- `GET /api/v1/recommendation/{symbol}`: 特定銘柄の推奨情報取得
- `GET /api/v1/stocks`: 利用可能な銘柄一覧取得
- `GET /api/v1/stock/{symbol}/data`: 株価データとテクニカル指標の取得
- `GET /api/v1/secure/stock/{symbol}/data`: セキュアな株価データ取得
- `POST /api/v1/secure/stocks/batch`: 複数銘柄の一括データ取得（セキュア）
- `GET /api/v1/secure/analysis/{symbol}`: 株式分析（管理者用）

### 2. モデル層

#### ファイル構成
- `models/precision/precision_87_system.py`: 87%精度突破統合システム
- `analysis/sentiment_analyzer.py`: ニュースセンチメント分析システム
- `systems/auto_retraining_system.py`: 自動再学習システム

#### 機能
- **87%精度突破統合システム**:
  - メタラーニングとDQN強化学習を統合した高度なアンサンブル手法
  - 84.6%のベースモデルを強化し、87%の精度を目指す
  - 実際の価格予測を実施し、信頼度と精度をチューニング
- **ニュースセンチメント分析**:
  - 複数ニュースソース（Yahoo Finance, Google News, etc.）から情報を取得
  - 日本語キーワードベースのセンチメント分析
  - 技術分析との統合（重み調整可能、デフォルト: 技術70% + センチメント30%）
  - 時間重み・関連度重みによる高精度分析
  - 並列処理による高速一括分析
- **自動再学習システム**:
  - モデル性能監視とドリフト検出
  - 自動再学習スケジューラー（24時間間隔）
  - 複数銘柄並列再学習（最大3銘柄同時）
  - モデルバックアップとロールバック

#### 87%精度達成の核心
- **ベースモデル**: 84.6%精度のトレンドフォローモデル
  - 強い上昇トレンド条件 (SMA10 > SMA20 > SMA50)
  - 価格変動率、RSI、移動平均などから方向性を予測
- **メタラーニング**: 銘柄ごとの特性に合わせたパラメータ適応
- **DQN強化学習**: トレーディングシグナルの強化と最適化
- **センチメント分析**: ニュースセンチメントを技術分析と統合
- **統合信頼度**: 87%精度維持のための動的重み調整

### 3. データ層

#### ファイル構成
- `data/stock_data.py`: 株価データの取得、前処理、テクニカル指標計算の中心的なクラス
- `utils/cache.py`: データキャッシング

#### 機能
- **データ取得**:
  - 信頼できるデータソース（ローカルCSVキャッシュ、HTTP API）を優先
  - yfinanceをフォールバックとして使用
  - 複数のティッカー形式（例：7203, 7203.T）を試行
- **データ前処理**:
  - OHLCVデータの正規化（欠損値補完、型変換）
  - 日付範囲のトリミング
- **テクニカル指標計算**:
  - 短期・中期移動平均 (SMA20, SMA50)
  - RSI (相対力指数)
  - MACD (移動平均収束拡散)
  - ATR (平均真価範囲)
- **財務指標取得**:
  - yfinance経由で市場資本時、P/Eレシオ、配当利回り、ベータ値などの基本財務指標
  - 収益、現金フロー、負債等の拡張財務指標
  - 配当情報（配当利回り、除権日など）
- **ニュースデータ取得**:
  - yfinance経由で銘柄関連ニュースを取得
- **キャッシング**:
  - 株価データ、財務指標、ニュースデータをキャッシュ

### 4. CLI層

#### ファイル構成
- `clstock_cli.py`: Clickベースの統合CLIインターフェース

#### 機能
- **サービス管理**:
  - サービスの開始 (`service start`)
  - サービスの停止 (`service stop`)
  - サービスの再起動 (`service restart`)
  - サービス状態の表示 (`service status`)
  - サービス監視の開始/停止 (`service monitor`)
- **システム管理**:
  - ダッシュボードの起動 (`system dashboard`)
  - デモ取引の開始 (`system demo`)
  - 予測システムの実行 (`system predict`)
  - 最適化システムの実行 (`system optimize`)
  - 統合テストサービスの実行 (`system integration`)
- **データ管理**:
  - 株価データの取得 (`data fetch`)
- **初期セットアップ**:
  - 必要なディレクトリ（logs, data, cache）の作成 (`setup`)
- **バージョン情報**:
  - システムバージョンの表示 (`version`)

### 5. システムコンポーネント

#### ファイル構成
- `systems/process_manager.py`: サービスプロセスの管理、監視、シャットダウン調整
- `systems/service_registry.py`: サービスの登録、状態管理
- `systems/monitoring.py`: プロセス監視機能
- `systems/shutdown_coordinator.py`: グレースフルシャットダウン機能

#### 機能
- **プロセス管理**:
  - サービスの開始、停止、再起動
  - プロセス状態の追跡（RUNNING, STOPPED, STARTING, STOPPING, FAILED, UNKNOWN）
  - プロセスのPID、起動時間、エラー記録
- **セキュリティ対策**:
  - 危険な文字（`;`, `&`, `|`, `>`, `<`, `` ` ``, `$`, `(`, `)`, `{`, `}`）と危険なコマンド（`rm`, `del`, `format`, `shutdown`, `reboot`）の検出
  - 引数のサニタイズと検証
- **リソース監視**:
  - プロセス単位のCPU使用率、メモリ使用量の監視
  - 設定された上限（CPU%, メモリMB）の超過検知と警告
  - 異常なリソース使用時のプロセス停止
- **プロセス健全性チェック**:
  - プロセスの生存確認と異常終了検出
  - 自動再起動機能（試行回数上限設定可能）
- **グレースフルシャットダウン**:
  - シグナル（SIGINT, SIGTERM）のハンドリング
  - 全サービスの順序立てた停止
  - スレッドプールとイベントのクリーンアップ
- **出力ログ記録**:
  - サービスプロセスの標準出力/標準エラーを非同期でキャプチャ
  - ログファイルへの出力